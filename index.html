<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Manager</title>
    <meta name="description" content="Modern dashboard for collecting, verifying, and exporting API credentials for Facebook, GitHub, Twitter (X), and OpenAI.">
    <link rel="stylesheet" href="assets/app.css">
</head>
<body>
    <header class="page-header">
        <div class="page-header__content">
            <div class="page-header__top">
                <a class="app-logo" href="index.html" aria-label="Loki Launcher home">
                    <span class="app-logo__mark" aria-hidden="true">
                        <img src="assets/loki-launcher-logo.svg" alt="" />
                    </span>
                    <span class="app-logo__text">
                        <span class="app-logo__title">Loki Launcher</span>
                        <span class="app-logo__subtitle">Mission Control</span>
                    </span>
                </a>
                <nav class="page-nav" aria-label="Primary">
                    <a href="index.html" class="page-nav__link is-active">Credentials</a>
                    <a href="composer.html" class="page-nav__link">Post Composer</a>
                    <a href="templates.html" class="page-nav__link">Templates</a>
                    <a href="notifications.html" class="page-nav__link">Notifications</a>
                </nav>
            </div>
            <h1 class="page-header__title">API Key Manager</h1>
            <p class="page-header__subtitle">Collect credentials, validate access, and run quick smoke tests for Facebook, GitHub, Twitter (X), and OpenAI APIs without leaving your browser.</p>
        </div>
    </header>

    <main class="page-layout page-layout--two-column">
        <section aria-label="Connected platforms">
            <div class="platform-grid">
                <article class="platform-card" id="facebook">
                    <header class="platform-card__header">
                        <div class="platform-card__logo">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook logo">
                        </div>
                        <div>
                            <h2 class="platform-card__title">Facebook</h2>
                            <p class="platform-card__summary">Exchange tokens and validate Graph API access for your Meta apps.</p>
                        </div>
                    </header>
                    <form class="platform-form form-grid" autocomplete="off" novalidate>
                        <div class="form-row">
                            <label class="input-label" for="fb_app_id">App ID</label>
                            <input class="input-control" type="text" id="fb_app_id" placeholder="Enter your Facebook App ID" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="fb_app_secret">App Secret</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="fb_app_secret" placeholder="Enter your Facebook App Secret" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="fb_app_secret" aria-controls="fb_app_secret">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="fb_short_token">Short-lived User Access Token</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="fb_short_token" placeholder="Paste your short-lived token" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="fb_short_token" aria-controls="fb_short_token">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="fb_long_token">Long-lived User Access Token</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="fb_long_token" placeholder="Exchange to populate" autocomplete="off" data-sensitive readonly>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="fb_long_token" aria-controls="fb_long_token">Show</button>
                            </div>
                        </div>
                        <div class="action-row">
                            <button type="button" class="button button--primary" data-action="verifyFacebook">Verify</button>
                            <button type="button" class="button button--primary" data-action="exchangeFacebookToken">Exchange for Long-term Token</button>
                            <button type="button" class="button button--primary" data-action="testPostFacebook">Test Post</button>
                        </div>
                    </form>
                </article>

                <article class="platform-card" id="github">
                    <header class="platform-card__header">
                        <div class="platform-card__logo">
                            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub logo">
                        </div>
                        <div>
                            <h2 class="platform-card__title">GitHub</h2>
                            <p class="platform-card__summary">Confirm PATs or OAuth tokens and spin up quick Gist test posts.</p>
                        </div>
                    </header>
                    <form class="platform-form form-grid" autocomplete="off" novalidate>
                        <div class="form-row">
                            <label class="input-label" for="gh_client_id">Client ID (OAuth App)</label>
                            <input class="input-control" type="text" id="gh_client_id" placeholder="Enter your GitHub OAuth client ID" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="gh_client_secret">Client Secret (OAuth App)</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="gh_client_secret" placeholder="Enter your GitHub client secret" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="gh_client_secret" aria-controls="gh_client_secret">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="gh_pat">Personal Access Token</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="gh_pat" placeholder="Paste your PAT" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="gh_pat" aria-controls="gh_pat">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="gh_access_token">Access Token (OAuth)</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="gh_access_token" placeholder="Paste the OAuth access token" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="gh_access_token" aria-controls="gh_access_token">Show</button>
                            </div>
                        </div>
                        <div class="action-row">
                            <button type="button" class="button button--primary" data-action="verifyGitHub">Verify</button>
                            <button type="button" class="button button--primary" data-action="testPostGitHub">Test Post (Create Gist)</button>
                        </div>
                    </form>
                </article>

                <article class="platform-card" id="twitter">
                    <header class="platform-card__header">
                        <div class="platform-card__logo">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6f/Logo_of_Twitter.svg" alt="Twitter (X) logo">
                        </div>
                        <div>
                            <h2 class="platform-card__title">Twitter (X)</h2>
                            <p class="platform-card__summary">Refresh OAuth tokens and validate posting permissions on X.</p>
                        </div>
                    </header>
                    <form class="platform-form form-grid" autocomplete="off" novalidate>
                        <div class="form-row">
                            <label class="input-label" for="tw_client_id">Client ID</label>
                            <input class="input-control" type="text" id="tw_client_id" placeholder="Enter your X client ID" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="tw_client_secret">Client Secret</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="tw_client_secret" placeholder="Enter your X client secret" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="tw_client_secret" aria-controls="tw_client_secret">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="tw_access_token">Access Token</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="tw_access_token" placeholder="Paste the current access token" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="tw_access_token" aria-controls="tw_access_token">Show</button>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="input-label" for="tw_refresh_token">Refresh Token</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="tw_refresh_token" placeholder="Paste the refresh token" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="tw_refresh_token" aria-controls="tw_refresh_token">Show</button>
                            </div>
                        </div>
                        <div class="action-row">
                            <button type="button" class="button button--primary" data-action="verifyTwitter">Verify</button>
                            <button type="button" class="button button--primary" data-action="refreshTwitterToken">Refresh Token</button>
                            <button type="button" class="button button--primary" data-action="testPostTwitter">Test Post</button>
                        </div>
                    </form>
                </article>

                <article class="platform-card" id="openai">
                    <header class="platform-card__header">
                        <div class="platform-card__logo">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/OpenAI_Logo.svg" alt="OpenAI logo">
                        </div>
                        <div>
                            <h2 class="platform-card__title">OpenAI</h2>
                            <p class="platform-card__summary">Check API key validity and send a quick chat completion request.</p>
                        </div>
                    </header>
                    <form class="platform-form form-grid" autocomplete="off" novalidate>
                        <div class="form-row">
                            <label class="input-label" for="oai_api_key">API Key</label>
                            <div class="input-with-toggle">
                                <input class="input-control" type="password" id="oai_api_key" placeholder="Enter your OpenAI API key" autocomplete="off" data-sensitive>
                                <button type="button" class="button button--tertiary toggle-visibility" data-toggle="oai_api_key" aria-controls="oai_api_key">Show</button>
                            </div>
                        </div>
                        <div class="action-row">
                            <button type="button" class="button button--primary" data-action="verifyOpenAI">Verify</button>
                            <button type="button" class="button button--primary" data-action="testPostOpenAI">Test Request</button>
                        </div>
                    </form>
                </article>
            </div>
        </section>

        <aside class="sidebar">
            <section class="card credentials-summary" aria-label="Credential health overview">
                <div class="credentials-summary__header">
                    <h2>Credential health</h2>
                    <span class="credentials-summary__total" id="credential-summary-total">0 of 4 platforms ready</span>
                </div>
                <ul class="credentials-summary__list">
                    <li class="credentials-summary__item credentials-summary__item--facebook" data-credential-summary="facebook">
                        <div class="credentials-summary__meta">
                            <span class="credentials-summary__platform">Facebook</span>
                            <span class="credentials-summary__counts" data-credential-count>0/4 fields stored</span>
                        </div>
                        <span class="status-chip status-chip--missing" data-credential-chip>Needs setup</span>
                    </li>
                    <li class="credentials-summary__item credentials-summary__item--github" data-credential-summary="github">
                        <div class="credentials-summary__meta">
                            <span class="credentials-summary__platform">GitHub</span>
                            <span class="credentials-summary__counts" data-credential-count>0/4 fields stored</span>
                        </div>
                        <span class="status-chip status-chip--missing" data-credential-chip>Needs setup</span>
                    </li>
                    <li class="credentials-summary__item credentials-summary__item--twitter" data-credential-summary="twitter">
                        <div class="credentials-summary__meta">
                            <span class="credentials-summary__platform">Twitter (X)</span>
                            <span class="credentials-summary__counts" data-credential-count>0/4 fields stored</span>
                        </div>
                        <span class="status-chip status-chip--missing" data-credential-chip>Needs setup</span>
                    </li>
                    <li class="credentials-summary__item credentials-summary__item--openai" data-credential-summary="openai">
                        <div class="credentials-summary__meta">
                            <span class="credentials-summary__platform">OpenAI</span>
                            <span class="credentials-summary__counts" data-credential-count>0/1 fields stored</span>
                        </div>
                        <span class="status-chip status-chip--missing" data-credential-chip>Needs setup</span>
                    </li>
                </ul>
            </section>
            <section class="actions-panel" aria-label="Utility actions">
                <h2>Utilities</h2>
                <div class="actions-panel__buttons">
                    <button type="button" class="button button--secondary" data-action="saveToCSV">Save All to CSV</button>
                    <button type="button" class="button button--secondary" data-action="copyCredentials">Copy credentials</button>
                </div>
                <div class="actions-panel__stack">
                    <button type="button" class="button button--ghost" data-action="clearAllCredentials">Clear stored credentials</button>
                    <button type="button" class="button button--secondary" data-action="clearConsole">Clear Console</button>
                </div>
                <p class="actions-panel__hint">Everything stays in the browser until you export it. Keep the CSV secure.</p>
            </section>

            <section class="console-panel" aria-labelledby="console-title">
                <div class="console-panel__header">
                    <h2 id="console-title">Console</h2>
                </div>
                <div id="console" class="console-log" role="log" aria-live="polite" aria-atomic="false"></div>
            </section>

            <section class="resources" aria-labelledby="resource-links-title">
                <h2 id="resource-links-title">API Explorers</h2>
                <ul class="resource-list">
                    <li><a href="https://developers.facebook.com/tools/explorer/" target="_blank" rel="noopener noreferrer">Facebook Graph API Explorer</a></li>
                    <li><a href="https://docs.github.com/en/rest" target="_blank" rel="noopener noreferrer">GitHub REST API Docs</a></li>
                    <li><a href="https://developer.twitter.com/en/docs/twitter-api/tools-and-libraries/api-reference" target="_blank" rel="noopener noreferrer">Twitter (X) API Reference</a></li>
                    <li><a href="https://platform.openai.com/docs/api-reference" target="_blank" rel="noopener noreferrer">OpenAI API Reference</a></li>
                </ul>
            </section>
        </aside>
    </main>

    <script>
        (() => {
            const consoleEl = document.getElementById('console');
            const storagePrefix = 'akm:';
            const summaryTotalEl = document.getElementById('credential-summary-total');
            const summaryItems = new Map();
            document.querySelectorAll('[data-credential-summary]').forEach((item) => {
                summaryItems.set(item.dataset.credentialSummary, {
                    item,
                    countEl: item.querySelector('[data-credential-count]'),
                    chipEl: item.querySelector('[data-credential-chip]')
                });
            });

            const credentialPlatforms = {
                facebook: {
                    name: 'Facebook',
                    fields: [
                        { label: 'App ID', id: 'fb_app_id' },
                        { label: 'App Secret', id: 'fb_app_secret' },
                        { label: 'Short-lived Token', id: 'fb_short_token' },
                        { label: 'Long-lived Token', id: 'fb_long_token' }
                    ],
                    ready: (has) => has('fb_app_id') && (has('fb_long_token') || has('fb_short_token')),
                    statusMessage: ({ has }) => {
                        if (!has('fb_app_id')) {
                            return 'Add App ID';
                        }
                        if (!has('fb_short_token') && !has('fb_long_token')) {
                            return 'Add access token';
                        }
                        return 'Incomplete';
                    }
                },
                github: {
                    name: 'GitHub',
                    fields: [
                        { label: 'Client ID', id: 'gh_client_id' },
                        { label: 'Client Secret', id: 'gh_client_secret' },
                        { label: 'Personal Access Token', id: 'gh_pat' },
                        { label: 'Access Token', id: 'gh_access_token' }
                    ],
                    ready: (has) => has('gh_pat') || has('gh_access_token'),
                    statusMessage: ({ has }) => {
                        if (!has('gh_pat') && !has('gh_access_token')) {
                            return 'Add PAT or OAuth token';
                        }
                        return 'Incomplete';
                    }
                },
                twitter: {
                    name: 'Twitter (X)',
                    fields: [
                        { label: 'Client ID', id: 'tw_client_id' },
                        { label: 'Client Secret', id: 'tw_client_secret' },
                        { label: 'Access Token', id: 'tw_access_token' },
                        { label: 'Refresh Token', id: 'tw_refresh_token' }
                    ],
                    ready: (has) => has('tw_access_token'),
                    statusMessage: ({ has }) => {
                        if (!has('tw_access_token')) {
                            return 'Add access token';
                        }
                        return 'Incomplete';
                    }
                },
                openai: {
                    name: 'OpenAI',
                    fields: [
                        { label: 'API Key', id: 'oai_api_key' }
                    ],
                    ready: (has) => has('oai_api_key'),
                    statusMessage: () => 'Add API key'
                }
            };

            const storageAvailable = (() => {
                try {
                    const key = `${storagePrefix}__test__`;
                    localStorage.setItem(key, '1');
                    localStorage.removeItem(key);
                    return true;
                } catch {
                    return false;
                }
            })();

            const storageKeyFor = (id) => `${storagePrefix}${id}`;

            const readStoredValue = (id) => {
                if (!storageAvailable) {
                    return '';
                }
                return localStorage.getItem(storageKeyFor(id)) ?? '';
            };

            const getValue = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    return el.value.trim();
                }

                return readStoredValue(id).trim();
            };

            const persistValue = (id, value) => {
                if (!storageAvailable) {
                    return;
                }
                const key = storageKeyFor(id);
                const sanitized = value?.trim() ?? '';
                if (sanitized) {
                    localStorage.setItem(key, sanitized);
                } else {
                    localStorage.removeItem(key);
                }
            };

            const setValue = (id, value) => {
                const el = document.getElementById(id);
                const resolved = value ?? '';
                if (el) {
                    el.value = resolved;
                }

                persistValue(id, resolved);
                updateCredentialSummary();
            };

            function updateCredentialSummary() {
                if (!summaryItems.size) {
                    if (summaryTotalEl) {
                        summaryTotalEl.textContent = '0 of 0 platforms ready';
                    }
                    return;
                }

                let readyCount = 0;
                const entries = Object.entries(credentialPlatforms);

                entries.forEach(([key, platform]) => {
                    const summary = summaryItems.get(key);
                    if (!summary) {
                        return;
                    }

                    const has = (fieldId) => Boolean(getValue(fieldId));
                    const storedFields = platform.fields.filter((field) => has(field.id));
                    const storedCount = storedFields.length;
                    const missingCount = platform.fields.length - storedCount;
                    const ready = typeof platform.ready === 'function'
                        ? platform.ready(has)
                        : storedCount === platform.fields.length;

                    if (summary.countEl) {
                        const label = platform.fields.length === 1 ? 'field' : 'fields';
                        summary.countEl.textContent = `${storedCount}/${platform.fields.length} ${label} stored`;
                    }

                    if (summary.chipEl) {
                        let chipText = 'Needs setup';
                        if (ready) {
                            chipText = 'Ready';
                        } else if (typeof platform.statusMessage === 'function') {
                            chipText = platform.statusMessage({ has, storedCount, missingCount }) ?? 'Incomplete';
                        } else if (storedCount) {
                            chipText = missingCount === 1 ? 'Missing 1 field' : `Missing ${missingCount} fields`;
                        }

                        summary.chipEl.textContent = chipText;
                        summary.chipEl.classList.toggle('status-chip--ready', ready);
                        summary.chipEl.classList.toggle('status-chip--missing', !ready);
                    }

                    summary.item.classList.toggle('is-ready', ready);
                    summary.item.classList.toggle('is-missing', !ready);

                    if (ready) {
                        readyCount += 1;
                    }
                });

                if (summaryTotalEl) {
                    summaryTotalEl.textContent = `${readyCount} of ${entries.length} platforms ready`;
                }
            }

            const hydrateInputsFromStorage = () => {
                document.querySelectorAll('.input-control[id]').forEach((input) => {
                    if (storageAvailable) {
                        const stored = readStoredValue(input.id);
                        if (stored) {
                            input.value = stored;
                        }
                    }

                    input.addEventListener('input', () => {
                        persistValue(input.id, input.value);
                        updateCredentialSummary();
                    });
                });

                updateCredentialSummary();
            };

            hydrateInputsFromStorage();

            const log = (message, type = 'info') => {
                if (!consoleEl) return;
                const entry = document.createElement('div');
                entry.className = `log-entry log-entry--${type}`;

                const timeSpan = document.createElement('span');
                timeSpan.className = 'log-entry__time';
                timeSpan.textContent = new Date().toLocaleTimeString();

                const messageSpan = document.createElement('span');
                messageSpan.className = 'log-entry__message';
                messageSpan.textContent = message;

                entry.append(timeSpan, messageSpan);
                consoleEl.appendChild(entry);
                consoleEl.scrollTop = consoleEl.scrollHeight;
            };

            const handleAction = async (button, action) => {
                if (typeof action !== 'function') {
                    return;
                }

                button.disabled = true;
                button.classList.add('is-busy');

                try {
                    await action();
                } catch (error) {
                    const message = error instanceof Error ? error.message : String(error);
                    log(message, 'error');
                } finally {
                    button.disabled = false;
                    button.classList.remove('is-busy');
                }
            };

            const requireFields = (fields, platform) => {
                const missing = fields.filter(({ id }) => !getValue(id));
                if (missing.length) {
                    const labels = missing.map((field) => field.label).join(', ');
                    throw new Error(`${platform} requires: ${labels}.`);
                }
            };

            const buildCSV = () => {
                const rows = [['Platform', 'Field', 'Value']];

                Object.values(credentialPlatforms).forEach(({ name, fields }) => {
                    fields.forEach(({ label, id }) => {
                        const value = getValue(id).replace(/"/g, '""');
                        rows.push([name, label, value]);
                    });
                });

                return rows.map((row) => row.map((cell) => `"${cell}"`).join(',')).join('\n');
            };

            const buildCredentialText = () => {
                const sections = [];

                Object.values(credentialPlatforms).forEach(({ name, fields }) => {
                    const entries = fields
                        .map(({ label, id }) => ({ label, value: getValue(id) }))
                        .filter(({ value }) => Boolean(value));

                    if (entries.length) {
                        const lines = entries.map(({ label, value }) => `${label}: ${value}`);
                        sections.push(`${name}\n${lines.join('\n')}`);
                    }
                });

                return sections.join('\n\n');
            };

            const exportToCSV = () => {
                const csvContent = buildCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'api_keys.csv';
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            };

            const actions = {
                verifyFacebook: async () => {
                    const appId = getValue('fb_app_id');
                    const token = getValue('fb_long_token') || getValue('fb_short_token');
                    if (!appId || !token) {
                        throw new Error('Facebook verification requires both an App ID and an access token.');
                    }

                    log('Validating Facebook credentials…', 'info');
                    const response = await fetch(`https://graph.facebook.com/v20.0/me?access_token=${encodeURIComponent(token)}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Facebook verification failed. ${errorText || response.statusText}`);
                    }

                    log('Facebook read access verified via /me endpoint.', 'success');
                },
                exchangeFacebookToken: async () => {
                    requireFields([
                        { id: 'fb_app_id', label: 'App ID' },
                        { id: 'fb_app_secret', label: 'App Secret' },
                        { id: 'fb_short_token', label: 'Short-lived Token' }
                    ], 'Facebook');

                    log('Requesting Facebook long-lived token…', 'info');
                    const params = new URLSearchParams({
                        grant_type: 'fb_exchange_token',
                        client_id: getValue('fb_app_id'),
                        client_secret: getValue('fb_app_secret'),
                        fb_exchange_token: getValue('fb_short_token')
                    });

                    const response = await fetch(`https://graph.facebook.com/v20.0/oauth/access_token?${params.toString()}`);
                    const data = await response.json();

                    if (!response.ok || data.error) {
                        const message = data?.error?.message || response.statusText;
                        throw new Error(`Facebook token exchange failed. ${message}`);
                    }

                    setValue('fb_long_token', data.access_token ?? '');
                    log('Facebook long-lived token obtained successfully.', 'success');
                },
                testPostFacebook: async () => {
                    const token = getValue('fb_long_token') || getValue('fb_short_token');
                    if (!token) {
                        throw new Error('Provide a Facebook user token before posting.');
                    }

                    log('Submitting Facebook feed test post…', 'info');
                    const response = await fetch(`https://graph.facebook.com/v20.0/me/feed?access_token=${encodeURIComponent(token)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: 'Test post from API Key Manager' })
                    });
                    const data = await response.json();

                    if (!response.ok || data.error) {
                        const message = data?.error?.message || response.statusText;
                        throw new Error(`Facebook test post failed. ${message}`);
                    }

                    log(`Facebook test post succeeded. Post ID: ${data.id}`, 'success');
                },
                verifyGitHub: async () => {
                    const token = getValue('gh_pat') || getValue('gh_access_token');
                    if (!token) {
                        throw new Error('Provide a GitHub personal access token or OAuth token.');
                    }

                    log('Validating GitHub token via /user…', 'info');
                    const response = await fetch('https://api.github.com/user', {
                        headers: { Authorization: `token ${token}` }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`GitHub verification failed. ${errorText || response.statusText}`);
                    }

                    log('GitHub authentication verified. User endpoint responded successfully.', 'success');
                },
                testPostGitHub: async () => {
                    const token = getValue('gh_pat') || getValue('gh_access_token');
                    if (!token) {
                        throw new Error('Provide a GitHub token before creating a gist.');
                    }

                    log('Creating private GitHub gist for verification…', 'info');
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            Authorization: `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Test gist from API Key Manager',
                            public: false,
                            files: {
                                'test.txt': {
                                    content: 'Test content'
                                }
                            }
                        })
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        const message = data?.message || response.statusText;
                        throw new Error(`GitHub test gist failed. ${message}`);
                    }

                    log(`GitHub test gist created: ${data.html_url}`, 'success');
                },
                verifyTwitter: async () => {
                    const accessToken = getValue('tw_access_token');
                    if (!accessToken) {
                        throw new Error('Provide a Twitter access token before verification.');
                    }

                    log('Validating Twitter (X) access token via /users/me…', 'info');
                    const response = await fetch('https://api.twitter.com/2/users/me', {
                        headers: { Authorization: `Bearer ${accessToken}` }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Twitter verification failed. ${errorText || response.statusText}`);
                    }

                    log('Twitter access token verified via /users/me endpoint.', 'success');
                },
                refreshTwitterToken: async () => {
                    requireFields([
                        { id: 'tw_client_id', label: 'Client ID' },
                        { id: 'tw_client_secret', label: 'Client Secret' },
                        { id: 'tw_refresh_token', label: 'Refresh Token' }
                    ], 'Twitter');

                    log('Refreshing Twitter OAuth token…', 'info');
                    const clientId = getValue('tw_client_id');
                    const clientSecret = getValue('tw_client_secret');
                    const refreshToken = getValue('tw_refresh_token');
                    const auth = btoa(`${clientId}:${clientSecret}`);
                    const body = new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    }).toString();

                    const response = await fetch('https://api.twitter.com/2/oauth2/token', {
                        method: 'POST',
                        headers: {
                            Authorization: `Basic ${auth}`,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body
                    });
                    const data = await response.json();

                    if (!response.ok || data.error) {
                        const message = data?.error_description || data?.error || response.statusText;
                        throw new Error(`Twitter token refresh failed. ${message}`);
                    }

                    setValue('tw_access_token', data.access_token ?? '');
                    setValue('tw_refresh_token', data.refresh_token ?? refreshToken);
                    log('Twitter token refreshed. New access token stored.', 'success');
                },
                testPostTwitter: async () => {
                    const accessToken = getValue('tw_access_token');
                    if (!accessToken) {
                        throw new Error('Provide a Twitter access token before posting.');
                    }

                    log('Publishing Twitter (X) test tweet…', 'info');
                    const response = await fetch('https://api.twitter.com/2/tweets', {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: 'Test post from API Key Manager' })
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        const message = data?.errors?.map((err) => err.detail).join(', ') || response.statusText;
                        throw new Error(`Twitter test post failed. ${message}`);
                    }

                    const tweetId = data?.data?.id || 'unknown';
                    log(`Twitter test post succeeded. Tweet ID: ${tweetId}`, 'success');
                },
                verifyOpenAI: async () => {
                    const apiKey = getValue('oai_api_key');
                    if (!apiKey) {
                        throw new Error('Provide an OpenAI API key before verification.');
                    }

                    log('Fetching OpenAI models to validate API key…', 'info');
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { Authorization: `Bearer ${apiKey}` }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`OpenAI verification failed. ${errorText || response.statusText}`);
                    }

                    log('OpenAI API key verified. Models endpoint responded successfully.', 'success');
                },
                testPostOpenAI: async () => {
                    const apiKey = getValue('oai_api_key');
                    if (!apiKey) {
                        throw new Error('Provide an OpenAI API key before sending a test request.');
                    }

                    log('Sending chat completion test request to OpenAI…', 'info');
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: 'Say this is a test' }]
                        })
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        const message = data?.error?.message || response.statusText;
                        throw new Error(`OpenAI test request failed. ${message}`);
                    }

                    log('OpenAI chat completion request succeeded.', 'success');
                },
                copyCredentials: async () => {
                    const text = buildCredentialText();
                    if (!text.trim()) {
                        throw new Error('Add credentials before copying to the clipboard.');
                    }

                    if (!navigator.clipboard) {
                        throw new Error('Clipboard access is not available in this browser.');
                    }

                    await navigator.clipboard.writeText(text);
                    log('Credentials copied to the clipboard.', 'success');
                },
                saveToCSV: async () => {
                    log('Exporting credentials to CSV…', 'info');
                    exportToCSV();
                    log('Credentials exported to api_keys.csv.', 'success');
                },
                clearAllCredentials: async () => {
                    Object.values(credentialPlatforms).forEach(({ fields }) => {
                        fields.forEach(({ id }) => setValue(id, ''));
                    });

                    document.querySelectorAll('[data-sensitive]').forEach((input) => {
                        input.type = 'password';
                    });

                    document.querySelectorAll('.toggle-visibility').forEach((button) => {
                        button.textContent = 'Show';
                        button.setAttribute('aria-pressed', 'false');
                    });

                    log('All stored credentials cleared from this browser session.', 'warn');
                },
                clearConsole: async () => {
                    if (consoleEl) {
                        consoleEl.innerHTML = '';
                    }
                    log('Console cleared.', 'info');
                }
            };

            if (storageAvailable) {
                window.addEventListener('storage', (event) => {
                    if (!event.key || !event.key.startsWith(storagePrefix)) {
                        return;
                    }

                    const id = event.key.slice(storagePrefix.length);
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = event.newValue ?? '';
                    }

                    updateCredentialSummary();
                });
            }

            document.querySelectorAll('.platform-form').forEach((form) => {
                form.addEventListener('submit', (event) => event.preventDefault());
            });

            document.querySelectorAll('[data-action]').forEach((button) => {
                const actionName = button.dataset.action;
                const action = actions[actionName];
                button.addEventListener('click', () => handleAction(button, action));
            });

            document.querySelectorAll('.toggle-visibility').forEach((button) => {
                const targetId = button.getAttribute('data-toggle');
                const input = document.getElementById(targetId);
                if (!input) {
                    return;
                }

                button.addEventListener('click', () => {
                    const isHidden = input.type === 'password';
                    input.type = isHidden ? 'text' : 'password';
                    button.textContent = isHidden ? 'Hide' : 'Show';
                    button.setAttribute('aria-pressed', String(isHidden));
                    input.focus({ preventScroll: true });
                });
            });
        })();
    </script>
</body>
</html>
